<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ğŸ’—</title>

    <script src="result.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
        }
        #heart {
            display: block;
        }
    </style>
</head>

<body style="background-color:#000;" onload="onload()">
    <canvas id="heart" width="1800" height="900"></canvas>
</body>

<script>
    // å­˜å‚¨è¾¹ç•Œä¿¡æ¯
    let minX, minY, maxX, maxY;
    let offscreenCanvas, offscreenCtx;
    let scale = 1;

    function onload() {
        const canvas = document.getElementById('heart');
        const ctx = canvas.getContext('2d');

        points = JSON.parse(points)

        // è®¡ç®—æ‰€æœ‰å¸§ä¸­çˆ±å¿ƒçš„åæ ‡è¾¹ç•Œ
        minX = Infinity; maxX = -Infinity;
        minY = Infinity; maxY = -Infinity;

        for (let j = 0; j < points.length; j++) {
            const frame_points = points[j];
            for (let i = 0; i < frame_points["x"].length; i++) {
                let y = frame_points["x"][i]
                let x = frame_points["y"][i]
                minX = Math.min(minX, x);
                maxX = Math.max(maxX, x);
                minY = Math.min(minY, y);
                maxY = Math.max(maxY, y);
            }
        }

        // çˆ±å¿ƒåŸå§‹å°ºå¯¸ï¼ˆåŠ ä¸€ç‚¹è¾¹è·ï¼‰
        const heartWidth = maxX - minX + 1;
        const heartHeight = maxY - minY + 1;

        // åˆ›å»ºç¦»å± canvasï¼Œå°ºå¯¸ä¸ºçˆ±å¿ƒåŸå§‹å¤§å°
        offscreenCanvas = document.createElement('canvas');
        offscreenCanvas.width = heartWidth;
        offscreenCanvas.height = heartHeight;
        offscreenCtx = offscreenCanvas.getContext('2d');

        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œä½¿çˆ±å¿ƒå ç”»å¸ƒçš„ 3/5
        const targetWidth = canvas.width * 0.6;
        const targetHeight = canvas.height * 0.6;
        scale = Math.min(targetWidth / heartWidth, targetHeight / heartHeight);

        // å¯ç”¨å›¾åƒå¹³æ»‘
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';

        console.log('çˆ±å¿ƒåŸå§‹å°ºå¯¸:', { heartWidth, heartHeight });
        console.log('ç¼©æ”¾æ¯”ä¾‹:', scale);
        console.log('ç¼©æ”¾åå°ºå¯¸:', { width: heartWidth * scale, height: heartHeight * scale });

        let currentFrame = 0;

        // ä½¿ç”¨å•ä¸ªå®šæ—¶å™¨å¾ªç¯æ’­æ”¾æ‰€æœ‰å¸§
        setInterval(() => {
            ctx.clearRect(0, 0, canvas.width, canvas.height)
            update(ctx, canvas, points[currentFrame])
            currentFrame = (currentFrame + 1) % points.length;
        }, 50);
    }

    function update(ctx, canvas, frame_points) {
        // æ¸…ç©ºç¦»å± canvas
        offscreenCtx.clearRect(0, 0, offscreenCanvas.width, offscreenCanvas.height);

        // åœ¨ç¦»å± canvas ä¸Šä»¥åŸå§‹å°ºå¯¸ç»˜åˆ¶ï¼ˆæ¯ç‚¹1åƒç´ ï¼‰
        const imageData = offscreenCtx.createImageData(offscreenCanvas.width, offscreenCanvas.height);

        for (let i = 0; i < frame_points["x"].length; i++) {
            let origY = frame_points["x"][i]
            let origX = frame_points["y"][i]
            let data = frame_points["data"][i]

            // ç›¸å¯¹äºè¾¹ç•Œåç§»
            let x = origX - minX;
            let y = origY - minY;

            if (x >= 0 && x < offscreenCanvas.width && y >= 0 && y < offscreenCanvas.height) {
                let index = (x + y * offscreenCanvas.width) * 4;
                imageData.data[index + 0] = Math.min(255, data[2] * 1.2);
                imageData.data[index + 1] = data[1];
                imageData.data[index + 2] = data[0];
                imageData.data[index + 3] = 255;
            }
        }

        offscreenCtx.putImageData(imageData, 0, 0);

        // è®¡ç®—ç»˜åˆ¶ä½ç½®ï¼Œä½¿çˆ±å¿ƒå±…ä¸­
        const destWidth = offscreenCanvas.width * scale;
        const destHeight = offscreenCanvas.height * scale;
        const destX = (canvas.width - destWidth) / 2;
        const destY = (canvas.height - destHeight) / 2;

        // ç”¨ drawImage ç¼©æ”¾ç»˜åˆ¶åˆ°ä¸» canvasï¼ˆæµè§ˆå™¨è‡ªåŠ¨æ’å€¼ï¼‰
        ctx.drawImage(offscreenCanvas, destX, destY, destWidth, destHeight);
    }
</script>

</html>