<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>ğŸ’— Love Heart</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        #background {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        #animation-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
            overflow: hidden;
        }

        .floating-item {
            position: absolute;
            bottom: -150px;
            opacity: 0.8;
            animation: floatUp linear forwards;
        }

        .balloon {
            border-radius: 50% 50% 50% 50%;
            box-shadow: inset -5px -5px 10px rgba(0, 0, 0, 0.1);
        }

        .balloon::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 2px;
            height: 40px;
            background: rgba(255, 255, 255, 0.6);
        }

        .bubble {
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0.4) 20%, rgba(255, 255, 255, 0.1) 60%, rgba(255, 255, 255, 0.4) 100%);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0) translateX(0) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.8;
            }

            100% {
                transform: translateY(-120vh) translateX(var(--drift)) rotate(var(--rot));
                opacity: 0;
            }
        }

        #videoContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
            text-align: center;
        }

        #video {
            width: 640px;
            height: 480px;
            border: 3px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            transform: scaleX(-1);
            /* é•œåƒç¿»è½¬ */
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 640px;
            height: 480px;
            transform: scaleX(-1);
            pointer-events: none;
        }

        #instruction {
            margin-top: 20px;
            font-size: 28px;
            color: white;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            font-weight: bold;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.05);
            }
        }

        #status {
            margin-top: 10px;
            font-size: 18px;
            color: #ffeb3b;
            text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.8);
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 24px;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.8);
            z-index: 3;
            display: none;
        }

        #textContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 3;
            text-align: center;
            width: 80%;
            max-width: 800px;
            max-height: 70vh;
            padding: 60px 40px;
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            border-radius: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: none;
            opacity: 0;
            transition: opacity 1s;
        }

        #textContainer.show {
            display: block;
            opacity: 1;
        }

        #textContent {
            transition: transform 0.6s ease-out;
            padding-bottom: 100px;
        }

        .text-line {
            color: #000000;
            font-size: 32px;
            line-height: 1.8;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            margin: 15px 0;
            opacity: 0;
            display: none;
        }

        .text-line.show {
            display: block;
            animation: fadeInUp 0.8s forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #textContent {
            position: relative;
            z-index: 10;
        }

        .text-line.first {
            font-size: 40px;
            font-weight: bold;
            color: #000000;
        }

        .text-line.last {
            font-size: 48px;
            font-weight: bold;
            color: #000000;
            margin-top: 40px;
            animation: fadeInUp 0.8s forwards, pulse 2s infinite 0.8s;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.5);
            }

            50% {
                transform: scale(1.05);
                text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.8);
            }
        }

        .text-line.instruction {
            font-size: 28px;
            font-weight: bold;
            color: #000000;
            margin-top: 20px;
        }

        .heart-icon {
            display: inline-block;
            color: #ff69b4;
            font-size: 40px;
            animation: heartbeat 1.5s infinite;
        }

        @keyframes heartbeat {

            0%,
            100% {
                transform: scale(1);
            }

            10% {
                transform: scale(1.2);
            }

            20% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <img id="background" src="imgs/bg_1.jpeg" alt="Background">

    <div id="textContainer">
        <div id="animation-container"></div>
        <div id="textContent"></div>
    </div>

    <div id="loading">
        åˆå§‹åŒ–ä¸­... <span class="heart-icon">ğŸ’—</span>
    </div>

    <div id="videoContainer" style="display: none;">
        <div style="position: relative; display: inline-block;">
            <video id="video" autoplay playsinline></video>
            <canvas id="canvas"></canvas>
        </div>
        <div id="instruction">
            <span class="heart-icon">ğŸ’—</span> è¯·ç”¨åŒæ‰‹æ¯”çˆ±å¿ƒæ‰‹åŠ¿ <span class="heart-icon">ğŸ’—</span>
        </div>
        <div id="status"></div>
        <div id="debug" style="color: white; margin-top: 10px; font-size: 14px;"></div>
    </div>

    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('loading');
        const videoContainer = document.getElementById('videoContainer');
        const textContainer = document.getElementById('textContainer');
        const textContent = document.getElementById('textContent');
        const statusDiv = document.getElementById('status');
        const debugDiv = document.getElementById('debug');
        const animationContainer = document.getElementById('animation-container');

        let hands;
        let camera;
        let heartDetectedFrames = 0;
        const requiredFrames = 15;

        // æ±‚å©šæ–‡æ¡ˆï¼ˆæŒ‰æ ‡ç‚¹åˆ†å‰²ï¼‰
        const proposalLines = [
            { text: 'å˜¿ï¼Œå°ç‹åŒå­¦ã€‚', special: 'first' },
            { text: 'ç¬¬ä¸€æ¬¡è§ä½ çš„é‚£ä¸ªå¤å¤©ï¼Œ' },
            { text: 'ç¦»æˆ‘ä»¬å…¶å®å¾ˆè¿œäº†ã€‚' },
            { text: 'ä»åˆä¸­æ“åœºé‚£è¿œè¿œçš„ä¸€çœ¼ï¼Œ' },
            { text: 'åˆ°ä¸Šæµ·åœ°é“ç«™éš”ç€å£ç½©çš„é‚£ä¸ªå»ï¼Œ' },
            { text: 'å†åˆ°æ­å·å…¬å¯“é‡Œï¼Œ' },
            { text: 'è¿™ä¸€ç›ä¸ºä½ äº®çš„ç¯ã€‚' },
            { text: 'æˆ‘èµ°äº†å¥½ä¹…å¥½ä¹…ï¼Œ' },
            { text: 'æ‰ç»ˆäºä»è§‚ä¼—å¸­ï¼Œ' },
            { text: 'èµ°åˆ°äº†ä½ çš„èº«è¾¹ã€‚' },
            { text: 'ä»¥å‰ï¼Œ' },
            { text: 'æˆ‘æŠŠå–œæ¬¢è—åœ¨å¿ƒé‡Œï¼Œ' },
            { text: 'å°å¿ƒç¿¼ç¿¼ã€‚' },
            { text: 'ç°åœ¨ï¼Œ' },
            { text: 'æˆ‘æƒ³æŠŠå…¨ä¸–ç•Œçš„å–œæ¬¢ï¼Œ' },
            { text: 'éƒ½æ§åˆ°ä½ é¢å‰ã€‚' },
            { text: 'å‡†å¤‡å¥½äº†å—ï¼Ÿ', special: 'last' },
            { text: 'è¯·å‘æˆ‘æ¯”ä¸ªå¿ƒï¼Œ', special: 'instruction' },
            { text: 'è§£é”æˆ‘ä»¬çš„æœªæ¥ã€‚', special: 'instruction' }
        ];

        let currentLineIndex = 0;
        let scrollOffset = 0;

        // ç”Ÿæˆéšæœºé¢œè‰²
        function getRandomColor(isDark = false) {
            const hue = Math.floor(Math.random() * 360);
            const sat = 70 + Math.floor(Math.random() * 30);
            const light = isDark ? 40 : 60 + Math.floor(Math.random() * 20);
            return `hsl(${hue}, ${sat}%, ${light}%)`;
        }

        // åˆ›å»ºæ¼‚æµ®å…ƒç´ 
        function createFloatingElement() {
            const el = document.createElement('div');
            el.className = 'floating-item';

            const isBalloon = Math.random() > 0.3; // 70% balloons, 30% bubbles

            // éšæœºå¤§å°
            const size = 30 + Math.random() * 40; // 30-70px
            el.style.width = `${size}px`;
            el.style.height = `${size}px`; // balloons are round mostly

            // éšæœºä½ç½®
            const left = Math.random() * 100;
            el.style.left = `${left}%`;

            // éšæœºæ¼‚ç§»å’Œæ—‹è½¬
            const drift = (Math.random() - 0.5) * 200 + 'px';
            const rot = (Math.random() - 0.5) * 60 + 'deg';
            el.style.setProperty('--drift', drift);
            el.style.setProperty('--rot', rot);

            // åŠ¨ç”»æ—¶é—´
            const duration = 8 + Math.random() * 10;
            el.style.animationDuration = `${duration}s`;

            if (isBalloon) {
                el.classList.add('balloon');
                el.style.backgroundColor = getRandomColor();
                // Balloon shape (slightly oval vertical usually, but here circle is ok)
                // Let's make it slightly oval
                el.style.height = `${size * 1.2}px`;
            } else {
                el.classList.add('bubble');
                // transparent-ish
            }

            animationContainer.appendChild(el);

            // åŠ¨ç”»ç»“æŸåç§»é™¤
            setTimeout(() => {
                el.remove();
            }, duration * 1000);
        }

        // å¯åŠ¨èƒŒæ™¯åŠ¨ç”»
        function startBackgroundAnimation() {
            // åˆå§‹åˆ›å»ºä¸€äº›
            for (let i = 0; i < 10; i++) {
                setTimeout(createFloatingElement, Math.random() * 3000);
            }
            // æŒç»­åˆ›å»º
            setInterval(createFloatingElement, 1500);
        }

        // æ˜¾ç¤ºæ–‡æ¡ˆï¼ˆé€è¡Œå‡ºç°ï¼‰
        function showProposalTexts() {
            // 5ç§’åæ˜¾ç¤ºç™½è‰²èƒŒæ™¯å¹¶å¼€å§‹æ˜¾ç¤ºç¬¬ä¸€è¡Œ
            setTimeout(() => {
                textContainer.classList.add('show');
                setTimeout(() => {
                    showNextLine();
                }, 500); // èƒŒæ™¯å‡ºç°å0.5ç§’å¼€å§‹æ–‡å­—
            }, 5000);
        }

        // æ˜¾ç¤ºä¸‹ä¸€è¡Œæ–‡å­—
        function showNextLine() {
            if (currentLineIndex >= proposalLines.length) {
                // æ‰€æœ‰æ–‡å­—æ˜¾ç¤ºå®Œæ¯•ï¼Œå‡†å¤‡æ·¡å‡º
                setTimeout(() => {
                    fadeOutTexts();
                }, 3000);
                return;
            }

            const item = proposalLines[currentLineIndex];
            const line = document.createElement('div');
            line.className = 'text-line' + (item.special ? ' ' + item.special : '');
            line.textContent = item.text;
            textContent.appendChild(line);

            // è§¦å‘åŠ¨ç”»
            setTimeout(() => {
                line.classList.add('show');
            }, 50);

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨
            setTimeout(() => {
                checkScroll();
            }, 100);

            currentLineIndex++;

            // æ˜¾ç¤ºä¸‹ä¸€è¡Œï¼ˆé—´éš”1.5ç§’ï¼‰
            setTimeout(() => {
                showNextLine();
            }, 1500);
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦æ»šåŠ¨
        function checkScroll() {
            const containerHeight = textContainer.clientHeight;
            const contentHeight = textContent.scrollHeight;
            const paddingTotal = 160; // ä¸Šä¸‹paddingæ€»å’Œ + é¢å¤–ç©ºé—´

            // å¦‚æœå†…å®¹é«˜åº¦è¶…è¿‡å®¹å™¨é«˜åº¦ï¼Œåˆ™æ»šåŠ¨
            if (contentHeight > containerHeight - paddingTotal) {
                // è®¡ç®—éœ€è¦æ»šåŠ¨çš„è·ç¦»ï¼Œç¡®ä¿æœ€æ–°çš„æ–‡å­—åœ¨å¯è§åŒºåŸŸå†…
                const lastLine = textContent.lastElementChild;
                if (lastLine) {
                    const lastLineBottom = lastLine.offsetTop + lastLine.offsetHeight;
                    const visibleBottom = scrollOffset + containerHeight - paddingTotal;

                    if (lastLineBottom > visibleBottom) {
                        scrollOffset = lastLineBottom - (containerHeight - paddingTotal);
                        textContent.style.transform = `translateY(-${scrollOffset}px)`;
                    }
                }
            }
        }

        // æ·¡å‡ºæ–‡æ¡ˆï¼Œå¯åŠ¨æ‘„åƒå¤´
        function fadeOutTexts() {
            textContainer.style.transition = 'opacity 1.5s';
            textContainer.style.opacity = '0';

            setTimeout(() => {
                textContainer.style.display = 'none';
                loading.style.display = 'block';
                initHandDetection();
            }, 1500);
        }

        // ç»˜åˆ¶æ‰‹éƒ¨å…³é”®ç‚¹
        function drawLandmarks(landmarks) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let hand of landmarks) {
                // ç»˜åˆ¶æ‰€æœ‰å…³é”®ç‚¹
                for (let i = 0; i < hand.length; i++) {
                    const point = hand[i];
                    const x = point.x * canvas.width;
                    const y = point.y * canvas.height;

                    ctx.beginPath();
                    ctx.arc(x, y, 5, 0, 2 * Math.PI);
                    ctx.fillStyle = i === 4 || i === 8 ? '#ff0000' : '#00ff00';
                    ctx.fill();

                    if (i === 4 || i === 8) {
                        ctx.fillStyle = 'white';
                        ctx.font = '12px Arial';
                        ctx.fillText(i === 4 ? 'thumb' : 'index', x + 8, y);
                    }
                }

                // ç»˜åˆ¶è¿çº¿
                const connections = [
                    [0, 1], [1, 2], [2, 3], [3, 4],
                    [0, 5], [5, 6], [6, 7], [7, 8],
                    [0, 9], [9, 10], [10, 11], [11, 12],
                    [0, 13], [13, 14], [14, 15], [15, 16],
                    [0, 17], [17, 18], [18, 19], [19, 20]
                ];

                ctx.strokeStyle = 'rgba(0, 255, 0, 0.5)';
                ctx.lineWidth = 2;
                for (let [start, end] of connections) {
                    const p1 = hand[start];
                    const p2 = hand[end];
                    ctx.beginPath();
                    ctx.moveTo(p1.x * canvas.width, p1.y * canvas.height);
                    ctx.lineTo(p2.x * canvas.width, p2.y * canvas.height);
                    ctx.stroke();
                }
            }
        }

        // æ£€æµ‹çˆ±å¿ƒæ‰‹åŠ¿
        function detectHeartGesture(landmarks) {
            if (landmarks.length !== 2) return { isHeart: false, debug: 'éœ€è¦åŒæ‰‹' };

            const hand1 = landmarks[0];
            const hand2 = landmarks[1];

            const thumb1Tip = hand1[4];
            const index1Tip = hand1[8];
            const thumb2Tip = hand2[4];
            const index2Tip = hand2[8];

            const distance = (p1, p2) => {
                return Math.sqrt(
                    Math.pow(p1.x - p2.x, 2) +
                    Math.pow(p1.y - p2.y, 2) +
                    Math.pow(p1.z - p2.z, 2)
                );
            };

            const thumbDistance = distance(thumb1Tip, thumb2Tip);
            const indexDistance = distance(index1Tip, index2Tip);
            const leftHandSpan = distance(thumb1Tip, index1Tip);
            const rightHandSpan = distance(thumb2Tip, index2Tip);

            const debugInfo = `
                æ‹‡æŒ‡è·ç¦»: ${thumbDistance.toFixed(3)}
                é£ŸæŒ‡è·ç¦»: ${indexDistance.toFixed(3)}
                å·¦æ‰‹å¼ å¼€: ${leftHandSpan.toFixed(3)}
                å³æ‰‹å¼ å¼€: ${rightHandSpan.toFixed(3)}
            `;

            const isHeartGesture =
                thumbDistance < 0.15 &&
                indexDistance < 0.15 &&
                leftHandSpan > 0.05 && leftHandSpan < 0.3 &&
                rightHandSpan > 0.05 && rightHandSpan < 0.3;

            return { isHeart: isHeartGesture, debug: debugInfo };
        }

        // åˆå§‹åŒ– MediaPipe Hands
        async function initHandDetection() {
            hands = new Hands({
                locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }
            });

            hands.setOptions({
                maxNumHands: 2,
                modelComplexity: 1,
                minDetectionConfidence: 0.5,
                minTrackingConfidence: 0.5
            });

            hands.onResults(onResults);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: 640,
                        height: 480,
                        facingMode: 'user'
                    }
                });

                video.srcObject = stream;

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    loading.style.display = 'none';
                    videoContainer.style.display = 'block';

                    camera = new Camera(video, {
                        onFrame: async () => {
                            await hands.send({ image: video });
                        },
                        width: 640,
                        height: 480
                    });
                    camera.start();
                };
            } catch (error) {
                loading.textContent = 'æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·å…è®¸æ‘„åƒå¤´æƒé™';
                console.error('Camera error:', error);
            }
        }

        // å¤„ç†æ£€æµ‹ç»“æœ
        function onResults(results) {
            if (results.multiHandLandmarks) {
                drawLandmarks(results.multiHandLandmarks);
            }

            if (results.multiHandLandmarks && results.multiHandLandmarks.length === 2) {
                const result = detectHeartGesture(results.multiHandLandmarks);
                debugDiv.innerHTML = result.debug;

                if (result.isHeart) {
                    heartDetectedFrames++;
                    const progress = Math.floor((heartDetectedFrames / requiredFrames) * 100);
                    statusDiv.textContent = `æ£€æµ‹åˆ°çˆ±å¿ƒæ‰‹åŠ¿ï¼${progress}%`;
                    statusDiv.style.color = '#ff69b4';

                    if (heartDetectedFrames >= requiredFrames) {
                        statusDiv.textContent = 'æˆåŠŸï¼è·³è½¬ä¸­...';
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 500);
                    }
                } else {
                    heartDetectedFrames = Math.max(0, heartDetectedFrames - 1);
                    statusDiv.textContent = 'è¯·è°ƒæ•´æ‰‹åŠ¿...';
                    statusDiv.style.color = '#ffeb3b';
                }
            } else {
                heartDetectedFrames = Math.max(0, heartDetectedFrames - 2);
                if (results.multiHandLandmarks && results.multiHandLandmarks.length === 1) {
                    statusDiv.textContent = 'è¯·ä½¿ç”¨åŒæ‰‹æ¯”å¿ƒ';
                    debugDiv.textContent = 'åªæ£€æµ‹åˆ°ä¸€åªæ‰‹';
                } else {
                    statusDiv.textContent = 'æœªæ£€æµ‹åˆ°æ‰‹éƒ¨';
                    debugDiv.textContent = 'è¯·å°†åŒæ‰‹æ”¾åœ¨é•œå¤´å‰';
                }
                statusDiv.style.color = '#ffffff';
            }
        }

        // å¯åŠ¨ï¼šæ˜¾ç¤ºæ–‡æ¡ˆ
        // å¯åŠ¨ï¼šæ˜¾ç¤ºæ–‡æ¡ˆå¹¶å¼€å§‹åŠ¨ç”»
        startBackgroundAnimation();
        showProposalTexts();
    </script>
</body>

</html>